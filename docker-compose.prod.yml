# Arquivo: docker-compose.prod.yml (na raiz do projeto)

version: '3.8'

services:
  # 1. Serviço da Aplicação Django (App)
  app:
    build:
      context: .
      dockerfile: Dockerfile
    # Carregar variáveis de ambiente do .env
    env_file:
      - ./.env
    # Mapear variáveis de produção no ambiente do contêiner
    environment:
      # Definir chaves de produção (garante que DEBUG=False)
      DJANGO_DEBUG: 'False'
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
    # Expor a porta internamente para que o Caddy possa se conectar
    expose:
      - "8000"
    restart: always
    # Volumes para persistência e acesso do Caddy
    volumes:
      # Pasta onde o Django coleta estáticos (acessada pelo Caddy)
      - django_static:/usr/src/app/staticfiles_prod
      # Pasta de mídia (acessada pelo Caddy)
      - django_media:/usr/src/app/media_prod
      # Banco de dados SQLite (para persistência, se não for migrar para Postgre)
      - django_db:/usr/src/app/db.sqlite3 

  # 2. Serviço de Proxy Reverso Caddy (HTTPS/Reverse Proxy)
  caddy:
    image: caddy:2-alpine
    restart: always
    ports:
      # Expor as portas HTTP (80) e HTTPS (443) para o mundo
      - "80:80"
      - "443:443"
    volumes:
      # Mapear o Caddyfile de configuração
      - ./Caddyfile:/etc/caddy/Caddyfile
      # Mapear os volumes estáticos e de mídia para que o Caddy possa servir
      - django_static:/usr/src/app/staticfiles_prod
      - django_media:/usr/src/app/media_prod
      # Volume para persistência dos certificados SSL (muito importante!)
      - caddy_data:/data
    depends_on:
      - app

# Volumes para persistência de dados
volumes:
  django_db: # Para persistir o SQLite
  django_static: # Para os arquivos estáticos
  django_media:  # Para os arquivos de mídia (uploads)
  caddy_data:  # Para os certificados do Caddy